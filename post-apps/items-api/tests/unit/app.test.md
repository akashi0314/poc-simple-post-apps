# Lambda API テストケース一覧

## 📋 テスト概要

| 項目 | 内容 |
|------|------|
| **テスト対象** | Lambda API Handler (POST /items, GET /items/{id}) |
| **テストフレームワーク** | Jest |
| **モックライブラリ** | aws-sdk-client-mock |
| **総テストケース数** | 19 |

---

## 🔧 セットアップ・共通処理

| タイミング | 処理内容 |
|-----------|---------|
| **beforeEach** | ✓ DynamoDBモックのリセット<br>✓ 環境変数 `TABLE_NAME` = 'TestTable'<br>✓ `console.error` をモック化 |
| **afterEach** | ✓ 環境変数 `TABLE_NAME` の削除<br>✓ `console.error` モックのリストア |

---

## 📝 POST /items - アイテム作成（7テストケース）

### ✅ 正常系（2テストケース）

| No | テストケース名 | 入力データ | 期待するステータスコード | 期待する動作 |
|----|--------------|-----------|---------------------|------------|
| 1 | 有効なデータでアイテムを作成できる | `{name: 'テスト商品', price: 1000}` | **201** | ・id が自動生成される<br>・createdAt が設定される<br>・name, price が保持される<br>・DynamoDB PutCommand が1回実行 |
| 2 | IDを指定してアイテムを作成できる | `{id: 'custom-id-12345', name: 'カスタムID商品'}` | **201** | ・指定したカスタムIDが保持される<br>・その他のフィールドも正常に保存 |

### ❌ 異常系（5テストケース）

| No | テストケース名 | 入力データ | 期待するステータスコード | エラーメッセージ | 備考 |
|----|--------------|-----------|---------------------|----------------|------|
| 3 | リクエストボディが空の場合 | `body: null` | **400** | "Request body is required" | timestamp も含まれる |
| 4 | 不正なJSON形式の場合 | `"これは不正なJSON"` | **400** | "Invalid JSON format" | JSON.parse エラー |
| 5 | 空のオブジェクトの場合 | `{}` | **400** | "Request body cannot be empty" | オブジェクトは存在するがプロパティなし |
| 6 | IDが空文字列の場合 | `{id: '   ', name: 'テスト'}` | **400** | "ID must be a non-empty string" | 空白のみの文字列も拒否 |
| 7 | DynamoDBエラーの場合 | 有効なリクエスト + DynamoDBエラー発生 | **503** | "Database service unavailable" | 外部サービス障害のハンドリング |

---

## 🔍 GET /items/{id} - アイテム取得（6テストケース）

### ✅ 正常系（1テストケース）

| No | テストケース名 | 入力データ | 期待するステータスコード | 期待する動作 |
|----|--------------|-----------|---------------------|------------|
| 8 | 存在するアイテムを取得できる | `pathParameters: {id: 'test-id-12345'}` | **200** | ・DynamoDBから取得したアイテムがそのまま返される<br>・id, name, price, createdAt が含まれる<br>・DynamoDB GetCommand が1回実行 |

### ❌ 異常系（5テストケース）

| No | テストケース名 | 入力データ | 期待するステータスコード | エラーメッセージ | 備考 |
|----|--------------|-----------|---------------------|----------------|------|
| 9 | 存在しないアイテムの場合 | `pathParameters: {id: 'non-existent-id'}`<br>DynamoDB Item: undefined | **404** | "Item not found" | リソースが見つからない |
| 10 | パスパラメータがない場合 | `pathParameters: null` | **400** | "Path parameters are required" | 必須パラメータの欠落 |
| 11 | IDが空文字列の場合 | `pathParameters: {id: '   '}` | **400** | "ID parameter is required" | 空白のみの文字列も拒否 |
| 12 | IDが長すぎる場合 | `pathParameters: {id: 'a'.repeat(256)}` | **400** | "ID parameter is too long" | 256文字（上限255を超える） |
| 13 | DynamoDBエラーの場合 | 有効なID + DynamoDBエラー発生 | **503** | "Database service unavailable" | 外部サービス障害 |

---

## 🚫 サポートされていないHTTPメソッド（3テストケース）

| No | テストケース名 | HTTPメソッド | 期待するステータスコード | エラーメッセージ |
|----|--------------|-------------|---------------------|----------------|
| 14 | PUTメソッドは405エラー | PUT | **405** | "Method not allowed" |
| 15 | DELETEメソッドは405エラー | DELETE | **405** | "Method not allowed" |
| 16 | PATCHメソッドは405エラー | PATCH | **405** | "Method not allowed" |

---

## 🔐 エッジケースとセキュリティ（3テストケース）

| No | カテゴリ | テストケース名 | 入力データ | 期待するステータスコード | 検証内容 |
|----|---------|--------------|-----------|---------------------|---------|
| 17 | **セキュリティ** | 特殊文字を含むIDでも正常に動作 | `pathParameters: {id: 'test-id-<script>alert("xss")</script>'}` | **200** | ・XSS攻撃パターンが適切に処理される<br>・特殊文字がそのまま保持される<br>・エスケープ処理の確認 |
| 18 | **パフォーマンス** | 大きなJSONボディでも処理できる | `{name: 'テスト', description: 'a'.repeat(1000), tags: Array(100).fill('tag')}` | **201** | ・1000文字の文字列を含む<br>・100要素の配列を含む<br>・メモリ使用量の考慮 |
| 19 | **エッジケース** | (大きなデータの処理) | 上記に含む | **201** | ・大容量データのパース<br>・DynamoDBへの保存成功 |

---

## 📊 テストカバレッジサマリー

| カテゴリ | テスト数 | 割合 |
|---------|---------|------|
| POST /items | 7 | 36.8% |
| GET /items/{id} | 6 | 31.6% |
| HTTPメソッド検証 | 3 | 15.8% |
| エッジケース・セキュリティ | 3 | 15.8% |
| **合計** | **19** | **100%** |

---

## 🎯 HTTPステータスコード別

| ステータスコード | 説明 | 該当テスト数 |
|---------------|------|------------|
| **200** | OK（取得成功） | 2 |
| **201** | Created（作成成功） | 3 |
| **400** | Bad Request（リクエスト不正） | 8 |
| **404** | Not Found（リソース未発見） | 1 |
| **405** | Method Not Allowed（メソッド不許可） | 3 |
| **503** | Service Unavailable（サービス利用不可） | 2 |

---

## 🔍 モック検証ポイント

| 検証項目 | 説明 |
|---------|------|
| **DynamoDB呼び出し回数** | `expect(ddbMock.calls()).toHaveLength(1)` で検証 |
| **PutCommand実行** | アイテム作成時に正しく呼ばれるか |
| **GetCommand実行** | アイテム取得時に正しく呼ばれるか |
| **エラーハンドリング** | DynamoDBエラー時に適切なレスポンスを返すか |

---

## 📝 テスト実行コマンド

| コマンド | 説明 |
|---------|------|
| `npm test` | すべてのテストを実行 |
| `npm test -- --coverage` | カバレッジレポート付きで実行 |
| `npm test -- --watch` | ファイル変更を監視して自動実行 |