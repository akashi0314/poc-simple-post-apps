# 統合テスト・E2Eテスト

このディレクトリには、デプロイ済みのAPIエンドポイントに対する統合テストが含まれています。

## 📋 テストの種類

| ファイル | 用途 | 実行時間 | リクエスト数 |
|---------|------|---------|------------|
| `load_test.sh` | 基本的な機能テストと軽量負荷テスト | 約30秒 | 71件 |
| `advanced_load_test.sh` | 詳細なパフォーマンステストと負荷試験 | 数秒〜数分 | カスタマイズ可能 |

## 🚀 クイックスタート

```bash
# APIエンドポイントURLを環境変数に設定
export API_ENDPOINT="https://xxxxx.execute-api.us-east-1.amazonaws.com/Prod"

# 基本テスト実行
./load_test.sh $API_ENDPOINT

# 高度なテスト実行
./advanced_load_test.sh $API_ENDPOINT
```

## 📦 前提条件

### 必須コマンド

- ✅ `curl` - HTTPリクエスト送信
- ✅ `jq` - JSONパース
- ✅ `awk` - 計算処理（標準で入っている）

### インストール方法

```bash
# macOS
brew install curl jq

# Ubuntu/Debian/Codespaces
sudo apt-get update
sudo apt-get install -y curl jq

# Amazon Linux 2
sudo yum install -y curl jq
```

**注意:** `bc`コマンドは不要です。すべての計算は`awk`で行います。

## 🧪 load_test.sh - 基本負荷テスト

### 実行方法

```bash
./load_test.sh https://xxxxx.execute-api.us-east-1.amazonaws.com/Prod
```

### テスト項目

| # | テスト項目 | 内容 | リクエスト数 |
|---|----------|------|------------|
| 1 | **接続テスト** | APIエンドポイントへの接続確認 | 1 |
| 2 | **基本機能テスト** | POST → GET のデータ整合性確認 | 2 |
| 3 | **順次リクエスト** | 10回連続でPOSTリクエスト | 10 |
| 4 | **並列リクエスト** | 10件を同時に送信 | 10 |
| 5 | **高負荷テスト** | 50件を同時に送信 | 50 |
| 6 | **エラーハンドリング** | 404, 400エラーの検証 | 3 |

**合計: 76リクエスト**

### 期待される出力

```
========================================
API負荷テストツール
========================================
エンドポイント: https://xxxxx.execute-api.us-east-1.amazonaws.com/Prod

[1/6] 接続テスト...
✓ 接続成功 (HTTP 201)

[2/6] 基本機能テスト (POST → GET)...
✓ POST成功 (ID: 429ad549-9e39-44d1-92b8-c765118c73aa)
✓ GET成功 (データ整合性OK)

[3/6] 順次リクエストテスト (10回)...
  Request  1: 1.427s
  Request  2: 0.363s
  ...
✓ 完了
  平均応答時間: 0.536s
  最速: 0.281s
  最遅: 1.427s

[4/6] 並列リクエストテスト (10並列)...
✓ 完了
  総時間: 1.365s
  スループット: 7.33 req/sec

[5/6] 高負荷テスト (50並列)...
✓ 完了
  総時間: 3.565s
  スループット: 14.03 req/sec

[6/6] エラーハンドリングテスト...
✓ 404エラーハンドリング正常
✓ 400エラーハンドリング正常
✓ 空ボディエラーハンドリング正常

========================================
テスト結果サマリー
========================================
【パフォーマンス】
  順次実行 (平均): 0.536s
  並列10件: 1.365s (7.33 req/sec)
  並列50件: 3.565s (14.03 req/sec)

【応答時間】
  最速: 0.281s
  最遅: 1.427s

✓ 全テスト完了
```

## 📊 advanced_load_test.sh - 高度な負荷テスト

### 基本的な使い方

```bash
# デフォルト設定（100リクエスト、10並列）
./advanced_load_test.sh https://xxxxx.execute-api.us-east-1.amazonaws.com/Prod
```

### オプション

| オプション | 説明 | デフォルト値 |
|-----------|------|------------|
| `-n <数>` | リクエスト総数 | 100 |
| `-c <数>` | 並列実行数 | 10 |
| `-d <秒>` | バッチ間の遅延 | 0 |
| `-t <秒>` | タイムアウト時間 | 10 |
| `-o <FILE>` | 結果をJSONで保存 | - |

### 使用例

```bash
# 200リクエスト、20並列で実行
./advanced_load_test.sh $API_ENDPOINT -n 200 -c 20

# 結果をJSONファイルに保存
./advanced_load_test.sh $API_ENDPOINT -o results.json

# 全オプションを使用
./advanced_load_test.sh $API_ENDPOINT \
  -n 500 \
  -c 50 \
  -d 0.1 \
  -t 15 \
  -o test_results.json
```

### 期待される出力

```
========================================
高度なAPI負荷テストツール
========================================
エンドポイント: https://xxxxx.execute-api.us-east-1.amazonaws.com/Prod
リクエスト数: 100
並列実行数: 10
遅延: 0秒
タイムアウト: 10秒

接続テスト中...
✓ 接続成功

負荷テスト開始...
進捗: [##################################################] 100%

結果分析中...

========================================
テスト結果
========================================

【基本情報】
  エンドポイント: https://xxxxx.execute-api.us-east-1.amazonaws.com/Prod
  総リクエスト数: 100
  並列実行数: 10
  総実行時間: 9.542秒

【成功率】
  成功: 100 / 100 (100.00%)

【パフォーマンス】
  スループット: 10.48 req/sec
  平均応答時間: 0.680秒
  最速: 0.459秒
  最遅: 1.025秒

【パーセンタイル】
  50%tile (中央値): 0.560秒
  90%tile: 0.982秒
  95%tile: 0.997秒
  99%tile: 1.020秒

✓ テスト完了
```

### パーセンタイルの読み方

| パーセンタイル | 意味 |
|--------------|------|
| **50%tile (中央値)** | 半数のリクエストがこの時間以下で完了 |
| **90%tile** | 90%のリクエストがこの時間以下で完了 |
| **95%tile** | 95%のリクエストがこの時間以下で完了 |
| **99%tile** | 99%のリクエストがこの時間以下で完了 |

---

## 🎯 実践的なテストシナリオ

### シナリオ1: デプロイ後の動作確認

```bash
# デプロイ直後に実行（軽量）
./load_test.sh $API_ENDPOINT
```

### シナリオ2: パフォーマンスベンチマーク

```bash
# 詳細なパフォーマンス測定
./advanced_load_test.sh $API_ENDPOINT -n 100 -c 10 -o benchmark.json
```

### シナリオ3: 段階的負荷テスト

```bash
# 並列数を段階的に増やしてテスト
for concurrent in 5 10 20 50; do
  echo "=== Testing with $concurrent concurrent requests ==="
  ./advanced_load_test.sh $API_ENDPOINT \
    -n 100 \
    -c $concurrent \
    -o "results_c${concurrent}.json"
  sleep 5
done
```

### シナリオ4: 高負荷ストレステスト

```bash
# 500リクエスト、50並列で負荷をかける
./advanced_load_test.sh $API_ENDPOINT -n 500 -c 50 -o stress_test.json
```
